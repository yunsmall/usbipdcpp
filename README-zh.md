# usbipdcpp

ä¸€ä¸ªç”¨äºåˆ›å»º usbip æœåŠ¡å™¨çš„ C++ åº“

## åŠŸèƒ½ç‰¹æ€§

- âœ… **USBIP æœåŠ¡å™¨**: åŸºäº libusb å®ç°ï¼Œæ”¯æŒæ‰€æœ‰ libusb å…¼å®¹å¹³å°
- âœ… **è™šæ‹Ÿ HID è®¾å¤‡**: è·¨å¹³å°è™šæ‹Ÿ USB è®¾å¤‡æ”¯æŒï¼ˆæ— éœ€ libusbï¼‰ï¼Œè¯¦è§ `examples` ç›®å½•
- ğŸš€ **å¼‚æ­¥æ¶æ„**: ä½¿ç”¨ C++20 åç¨‹å’Œ asio å®ç°é«˜æ•ˆ I/O
- ğŸ§© **å¯æ‰©å±•è®¾è®¡**: æä¾›å®Œå–„çš„æŠ½è±¡æ¥å£ä¾›å¼€å‘è€…æ‰©å±•

æ¬¢è¿è´¡çŒ®ä»£ç ï¼ğŸš€

---

## æ¶æ„è®¾è®¡

USB é€šä¿¡å’Œç½‘ç»œé€šä¿¡éƒ½æ˜¯ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œæœ¬é¡¹ç›®é‡‡ç”¨å…¨å¼‚æ­¥æ¶æ„ï¼š

- ä½¿ç”¨ C++20 åç¨‹å¤„ç†ç½‘ç»œé€šä¿¡
- ä½¿ç”¨ asio å¼‚æ­¥é€šä¿¡
- ä½¿ç”¨ libusb å¼‚æ­¥æ¥å£å¤„ç† USB é€šä¿¡

### çº¿ç¨‹æ¨¡å‹

ç³»ç»ŸåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼š

1. **ç½‘ç»œ I/O çº¿ç¨‹**: è¿è¡Œ `asio::io_context::run()`ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
2. **USB ä¼ è¾“çº¿ç¨‹**: å¤„ç† `libusb_handle_events()`
3. **ä¸»çº¿ç¨‹**: æ§åˆ¶æœåŠ¡å™¨çš„è¡Œä¸ºï¼Œä»¥åŠç”¨äºå¯åŠ¨æœåŠ¡å™¨

æ¯ä¸ªè¿æ¥ä¼šå¯åŠ¨ä¸€ä¸ªå•ç‹¬çº¿ç¨‹ï¼Œé˜²æ­¢æŸäº›è®¾å¤‡çš„ä¸€äº›ç‰¹æ®ŠåŒæ­¥æ“ä½œé˜»å¡æ‰€æœ‰è®¾å¤‡ã€‚

å¦‚æœæ­¤æ—¶åˆå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¼šæ„Ÿè§‰å¤šæ­¤ä¸€ä¸¾ã€‚
é‰´äºæœ¬èº«å•ä¸ªæœåŠ¡å™¨çš„usbè®¾å¤‡ä¸ä¼šç‰¹åˆ«å¤šï¼Œè¿™ç§è®¾è®¡ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚

æ•°æ®ä¼ è¾“æµç¨‹ï¼š

```
ç½‘ç»œçº¿ç¨‹ â†’ libusb_submit_transfer â†’ USBçº¿ç¨‹ â†’ å›è°ƒ â†’ ç½‘ç»œçº¿ç¨‹
```

è¯¥æ¶æ„é€šè¿‡æœ€å°åŒ–çº¿ç¨‹ç«äº‰å®ç°é«˜ CPU æ•ˆç‡

### è™šæ‹Ÿè®¾å¤‡å®ç°

å¼€å‘è™šæ‹Ÿè®¾å¤‡æ—¶éœ€æ³¨æ„ï¼š

- é¿å…é˜»å¡ç½‘ç»œçº¿ç¨‹
- åœ¨å·¥ä½œçº¿ç¨‹ä¸­å¤„ç†è¯·æ±‚
- é€šè¿‡å›è°ƒæäº¤å“åº”æ•°æ®

---

## ä½¿ç”¨æŒ‡å—

### ä»£ç è¯´æ˜

> ğŸ“ æ³¨é‡Šå’Œæ—¥å¿—ä¸»è¦ä½¿ç”¨ä¸­æ–‡ï¼Œä»£ç ç»“æ„æ¸…æ™°æ˜“è¯»  
> æ¬¢è¿æäº¤è‹±æ–‡ç¿»è¯‘çš„ PRï¼

### æ‰©å±•åŠŸèƒ½

å®ç°è‡ªå®šä¹‰ USB è®¾å¤‡ï¼š

1. ä½¿ç”¨ `usbipdcpp::UsbDevice` å®šä¹‰è®¾å¤‡æè¿°ç¬¦
2. ç»§æ‰¿ `AbstDeviceHandler` å®ç°è®¾å¤‡é€»è¾‘
3. ä½¿ç”¨ `VirtualInterfaceHandler` å¤„ç†æ¥å£æ“ä½œï¼ŒåŒæ—¶å®ç°æ¥å£å†…çš„ç«¯ç‚¹çš„é€»è¾‘

ç®€å•è®¾å¤‡å¯ç›´æ¥ä½¿ç”¨ `SimpleVirtualDeviceHandler`ï¼Œå®ƒä¸ºæ ‡å‡†è¯·æ±‚æä¾›äº†ç©ºå®ç°

---

## âš ï¸ Windows ä½¿ç”¨æç¤º

åœ¨ Windows ä½¿ç”¨ libusb æœåŠ¡å™¨éœ€è¦æ›¿æ¢é©±åŠ¨ï¼š

1. ä½¿ç”¨ [Zadig](https://zadig.akeo.ie/) å®‰è£… WinUSB é©±åŠ¨
    - é€‰æ‹©ç›®æ ‡è®¾å¤‡ï¼ˆæ‰¾ä¸åˆ°è®¾å¤‡æ—¶å¯ç”¨"åˆ—å‡ºæ‰€æœ‰è®¾å¤‡"ï¼‰
    - **è­¦å‘Š**ï¼šæ›¿æ¢é¼ æ ‡/é”®ç›˜é©±åŠ¨ä¼šå¯¼è‡´è¾“å…¥å¤±æ•ˆ
2. ä½¿ç”¨åé€šè¿‡è®¾å¤‡ç®¡ç†å™¨å›æ»šé©±åŠ¨ï¼š
    - `Win+X` â†’ è®¾å¤‡ç®¡ç†å™¨ â†’ é€‰æ‹©è®¾å¤‡ â†’ å›æ»šé©±åŠ¨ç¨‹åº

å¯¹äºç‰©ç†è®¾å¤‡ï¼Œæ¨èä½¿ç”¨ [usbipd-win](https://github.com/dorssel/usbipd-win) ï¼Œ
è¯¥é¡¹ç›®ä½¿ç”¨VBoxUSBä»é©±åŠ¨å±‚é¢å®ç°ä¸Šè¿°åŠŸèƒ½
æœ¬é¡¹ç›®æ›´é€‚åˆåœ¨ Windows å®ç°**è™šæ‹Ÿ USB è®¾å¤‡**

---

## ä¾‹å­ä»‹ç»

1. libevdev_mouse

   ä½¿ç”¨libevdevåº“ï¼Œåœ¨æ”¯æŒevdevçš„ç³»ç»Ÿä¸Šï¼Œé€šè¿‡è¯»å–`/dev/input/event*`ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªusbipçš„é¼ æ ‡ï¼Œå®ç°è½¬å‘æœ¬åœ°çš„é¼ æ ‡ä¿¡å·
2. mock_mouse

   ä¸€ä¸ªæ¯éš”ä¸€ç§’å°±åˆ‡æ¢é¼ æ ‡å·¦é”®çŠ¶æ€çš„é¼ æ ‡ç¤ºä¾‹ã€‚ç”¨ä»¥ä»‹ç»è™šæ‹ŸHIDè®¾å¤‡çš„å†™æ³•
3. empty_server

   ä¸€ä¸ªåªæœ‰ä¸€ä¸ªè®¾å¤‡çš„usbipæœåŠ¡å™¨ã€‚è®¾å¤‡æ— ä»»ä½•åŠŸèƒ½ï¼Œä¸ä¼šå¯¹æ•°æ®åšç›¸åº”ã€‚
4. libusb_server

   è½¬å‘æœ¬æœºçš„usbè®¾å¤‡ï¼Œå¸¦ä¸€ä¸ªéå¸¸ç®€é™‹çš„å‘½ä»¤è¡Œï¼Œè¾“å…¥`h`æŸ¥çœ‹ç”¨æ³•ï¼Œå¯è‡ªè¡Œé€‰æ‹©è½¬å‘å“ªäº›è®¾å¤‡ã€‚
   é€šè¿‡æ·»åŠ è™šæ‹Ÿusbè®¾å¤‡å¯å®ç°å’ŒçœŸå®è®¾å¤‡å…±äº«åŒä¸€ä¸ªusbip server
5. termux_libusb_server

   å¯åœ¨érootå®‰å“è®¾å¤‡çš„termuxä¸­ä½¿ç”¨çš„libusb serverï¼Œé€šè¿‡
   `termux-usb -e /path/to/termux_libusb_server /dev/bus/usb/xxx/xxx`å¯åŠ¨ã€‚

   ç”±äºtermux-usbåªæ”¯æŒä¼ å…¥ä¸€ä¸ªfdï¼Œå› æ­¤å¯ä½¿ç”¨ä¸åŒç«¯å£å¯åŠ¨å¤šä¸ªæœåŠ¡å™¨ä»¥æ”¯æŒå¤šä¸ªè®¾å¤‡ã€‚
   ä½¿ç”¨`USBIPDCPP_LISTEN_PORT`ç¯å¢ƒå˜é‡æ¥æŒ‡å®šç›‘å¬ç«¯å£

   termux-usbçš„ä½¿ç”¨å¯æŸ¥çœ‹termuxå®˜æ–¹çš„ç›¸å…³æ–‡æ¡£
---

## ç¼–è¯‘å®‰è£…

è‹¥ä½¿ç”¨gccç¼–è¯‘ï¼Œæœ€ä½gccç‰ˆæœ¬ä¸º**gcc13**ã€‚**gcc14**ä¹‹ä¸‹çš„C++23æ ‡å‡†æ”¯æŒéƒ½æ˜¯æ®‹çš„ï¼Œ
ä¸æ˜¯`std::println`ä¸æ”¯æŒå°±æ˜¯`std::format`ä¸æ”¯æŒï¼Œç”¨å¾—ä¸€ç‚¹ä¹Ÿä¸èˆ’æœã€‚
ä¸ºäº†å…¼å®¹æ€§åªèƒ½æ”¾å¼ƒç¼–ç¨‹ä½“éªŒã€‚æ‰€ä»¥æˆ‘é€‰æ‹©äº†æ”¯æŒ`std::format`ä½†ä»ä¸æ”¯æŒ`std::println`çš„gcc13

æœ‰å¤šä¸ªé€‰é¡¹ç”¨äºæ§åˆ¶ç›¸åº”æ¨¡å—æ˜¯å¦ç¼–è¯‘ã€‚
å…·ä½“å€¼è§`CMakeLists.txt`

### å®Œæ•´ç¼–è¯‘å‘½ä»¤ï¼š

#### ä½¿ç”¨vcpkgåŒ…ç®¡ç†å™¨
è¯·æå‰è£…å¥½asio libusb libevdev spdlogç­‰åº“
```bash
cmake -B build \
-DCMAKE_TOOLCHAIN_FILE=/path/to/vcpkg/scripts/buildsystems/vcpkg.cmake
cmake --build build
cmake --install build
```

#### ä½¿ç”¨conanä½œä¸ºåŒ…ç®¡ç†å™¨ï¼š
```bash
conan install . --build=missing -s build_type=Release
cmake --preset conan-release
cmake --build build/Release
cmake --install build/Release
```

---

## ä½¿ç”¨

```cmake
find_package(usbipdcpp CONFIG REQUIRED)
target_link_libraries(main PRIVATE usbipdcpp::usbipdcpp)

# æˆ–è€…æƒ³ä½¿ç”¨libusbåŠŸèƒ½

find_package(usbipdcpp CONFIG REQUIRED COMPONENTS libusb)
target_link_libraries(main PRIVATE usbipdcpp::usbipdcpp usbipdcpp::usbipdcpp_libusb)
```

---

## è‡´è°¢

æœ¬é¡¹ç›®å—ç›Šäºä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [usbipd-libusb](https://github.com/raydudu/usbipd-libusb)
- [usbip](https://github.com/jiegec/usbip)